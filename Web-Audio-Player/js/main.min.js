import{equal,canvas,ctx,canvasWidth,canvasHeight,uploadButton,uploadInput,trackList,reloadButton,trackTitle,trackBar,trackTime,trackDuration,volumeBar,volumeLevel,playButton,pauseButton,stopButton,backwardButton,forwardButton,nextButton,prevButton,volumeButton,muteButton,shuffleButton,checkButton,fastButton,normalButton,visualButton,equalButton,listButton,freqInputs,popButton,rockButton,rapButton,defaultButton,popPreset,rockPreset,rapPreset}from"./buttons.min.js";function initPlayer(){let audio;function chooseTrack(){audio=trackList.querySelector(".checked audio"),audio.load(),audio.addEventListener("loadedmetadata",setDuration),trackTitle.innerText=audio.previousElementSibling.innerText,playButton.focus()}trackList.querySelector("figure").classList.add("checked"),chooseTrack();const figures=trackList.querySelectorAll("figure");function checkFigure(e){const oldFigure=trackList.querySelector(".checked");let newFigure;if("+"===e)newFigure=oldFigure.nextElementSibling,null===newFigure&&(newFigure=figures[0]);else if("-"===e)newFigure=oldFigure.previousElementSibling,null===newFigure&&(newFigure=figures[figures.length-1]);else if("r"===e)newFigure=figures[Math.floor(Math.random()*(figures.length-1))];else if(newFigure=e.target.parentNode,oldFigure===newFigure)return;oldFigure.classList.remove("checked"),newFigure.classList.add("checked"),changeTime("stop"),chooseTrack(),changeTime("play")}function setDuration(){let minutes=Math.trunc(audio.duration/60),seconds=Math.trunc(audio.duration);seconds>=60&&(seconds=Math.trunc(audio.duration%(60*minutes))),seconds<10&&(seconds="0"+seconds),trackDuration.innerText=`${minutes}:${seconds}`;const max=parseInt(10*audio.duration);trackBar.setAttribute("max",max)}function changeTime(e){"play"===e?(audio.play(),fastButton.isChecked?audio.playbackRate=2:audio.playbackRate=1,playButton.style.display="none",pauseButton.style.display="block",setDuration(),startVisual()):"pause"===e?(audio.pause(),playButton.style.display="block",pauseButton.style.display="none"):"stop"===e?(audio.load(),playButton.style.display="block",pauseButton.style.display="none"):"+"===e?audio.currentTime+=10:"-"===e?audio.currentTime-=10:audio.currentTime=e.offsetX/this.offsetWidth*audio.duration;const timer=setInterval(()=>{const minutes=Math.trunc(audio.currentTime/60);let seconds=Math.trunc(audio.currentTime);if(seconds>=60&&(seconds=Math.trunc(audio.currentTime%(60*minutes))),seconds<10&&(seconds="0"+seconds),trackTime.innerText=`${minutes}:${seconds}`,trackBar.value=parseInt(10*audio.currentTime),(audio.paused||audio.ended)&&clearInterval(timer),audio.ended){if(shuffleButton.isChecked)return void checkFigure("r");checkFigure("+")}},100)}function changeVolume(e){try{"off"===e?(audio.muted=!0,volumeButton.style.display="none",muteButton.style.display="block"):"on"===e?(audio.muted=!1,volumeButton.style.display="block",muteButton.style.display="none"):"+"===e?(audio.muted&&changeVolume("on"),audio.volume+=.1):"-"===e?(audio.volume-=.1,audio.volume<.1&&changeVolume("off")):(audio.muted&&changeVolume("on"),audio.volume=(e.offsetX/this.offsetWidth).toFixed(1),0===audio.volume&&changeVolume("off"))}catch{return}let value=10*Math.round(10*audio.volume);audio.muted&&(value=0),volumeBar.value=value,volumeLevel.innerText=value+"%"}let audioCtx,audioSrc;figures.forEach(figure=>{figure.addEventListener("click",checkFigure)}),playButton.addEventListener("click",()=>{changeTime("play")}),pauseButton.addEventListener("click",()=>{changeTime("pause")}),stopButton.addEventListener("click",()=>{changeTime("stop")}),backwardButton.addEventListener("click",()=>{changeTime("-")}),forwardButton.addEventListener("click",()=>{changeTime("+")}),trackBar.addEventListener("click",changeTime),nextButton.addEventListener("click",()=>shuffleButton.isChecked?checkFigure("r"):checkFigure("+")),prevButton.addEventListener("click",()=>shuffleButton.isChecked?checkFigure("r"):checkFigure("-")),volumeButton.addEventListener("click",()=>{changeVolume("on")}),muteButton.addEventListener("click",()=>{changeVolume("off")}),volumeBar.addEventListener("click",changeVolume),shuffleButton.addEventListener("click",()=>{shuffleButton.isChecked=!0,shuffleButton.style.display="none",checkButton.style.display="block",checkButton.focus()}),checkButton.addEventListener("click",()=>{shuffleButton.isChecked=!1,shuffleButton.style.display="block",checkButton.style.display="none",shuffleButton.focus()}),fastButton.addEventListener("click",()=>{fastButton.isChecked=!0,audio.played&&(audio.playbackRate=2),fastButton.style.display="none",normalButton.style.display="block",normalButton.focus()}),normalButton.addEventListener("click",()=>{fastButton.isChecked=!1,audio.played&&(audio.playbackRate=1),fastButton.style.display="block",normalButton.style.display="none",fastButton.focus()}),canvas.addEventListener("click",()=>{canvas.isChecked?canvas.isChecked=!1:canvas.isChecked=!0}),canvas.style.display="block",visualButton.addEventListener("click",()=>{"block"===canvas.style.display?canvas.style.display="none":canvas.style.display="block"}),equalButton.addEventListener("click",()=>{"flex"===equal.style.display?equal.style.display="none":equal.style.display="flex"}),listButton.addEventListener("click",()=>{"block"===trackList.style.display?trackList.style.display="none":trackList.style.display="block"}),document.addEventListener("keydown",e=>{e.preventDefault(),37===e.keyCode||100===e.keyCode?changeTime("-"):39===e.keyCode||102===e.keyCode?changeTime("+"):187===e.keyCode||107===e.keyCode||38===e.keyCode?changeVolume("+"):189===e.keyCode||109===e.keyCode||40===e.keyCode?changeVolume("-"):32===e.keyCode?audio.paused||audio.ended?changeTime("play"):changeTime("pause"):13===e.keyCode&&changeTime("stop")}),freqInputs.forEach(input=>{input.setAttribute("min",-15),input.setAttribute("max",15),input.setAttribute("step",.1),input.setAttribute("value",0),input.setAttribute("type","range")});let mediaArray=new WeakMap;function startVisual(){void 0===audioCtx&&(audioCtx=new AudioContext);const analyser=audioCtx.createAnalyser();mediaArray.has(audio)?audioSrc=mediaArray.get(audio):(audioSrc=audioCtx.createMediaElementSource(audio),mediaArray.set(audio,audioSrc)),audioSrc.connect(analyser),analyser.connect(audioCtx.destination),analyser.fftSize=256;const dataArray=new Uint8Array(analyser.frequencyBinCount),barWidth=canvasWidth/64*1.2;function renderFrame(){if(requestAnimationFrame(renderFrame),analyser.getByteFrequencyData(dataArray),ctx.clearRect(0,0,canvasWidth,canvasHeight),canvas.isChecked){ctx.strokeStyle="steelblue",ctx.beginPath(),ctx.moveTo(-2,0);for(let i=0,j=0;i<128;i++)if(i%2==0){let barHeight=dataArray[i]/6.4;ctx.lineTo(j,canvasHeight-barHeight),j+=barWidth}ctx.stroke()}else for(let i=0,j=0;i<128;i++)if(i%2==0){let barHeight=dataArray[i]/6.4;ctx.lineTo(j,canvasHeight-barHeight);let gradient=ctx.createLinearGradient(j,0,j+barWidth,0);gradient.addColorStop(.1,"#fff"),gradient.addColorStop(.2,"skyblue"),gradient.addColorStop(.8,"steelblue"),gradient.addColorStop(.9,"#fff"),ctx.fillStyle=gradient,ctx.fillRect(j,canvasHeight-barHeight,barWidth,barHeight),j+=barWidth}}renderFrame();let filters=[];function createFilters(){const frequencies=[31,87,175,350,700,1400,2800,5600,11200,16e3];filters=frequencies.map(frequency=>{const filter=audioCtx.createBiquadFilter();return filter.type="peaking",filter.frequency.value=frequency,filter.gain.value=0,filter.Q.value=1,filter}),filters.reduce((prev,curr)=>(prev.connect(curr),curr))}function initEvents(){freqInputs.forEach((i,j)=>{i.addEventListener("change",e=>{filters[j].gain.value=e.target.value,equal.querySelector(".frequency-value").innerText=filters[j].gain.value.toFixed(1)+"dB"})})}function setPreset(e){freqInputs.forEach((i,j)=>{"pop"===e?i.value=popPreset[j]:"rock"===e?i.value=rockPreset[j]:"rap"===e?i.value=rapPreset[j]:"default"===e&&(i.value=0),filters[j].gain.value=i.value,i.nextElementSibling.innerText=i.value+"dB"})}createFilters(),initEvents(),popButton.addEventListener("click",()=>setPreset("pop")),rockButton.addEventListener("click",()=>setPreset("rock")),rapButton.addEventListener("click",()=>setPreset("rap")),defaultButton.addEventListener("click",()=>setPreset("default")),audioSrc.connect(filters[0]),filters[9].connect(audioCtx.destination)}}uploadButton.addEventListener("click",()=>{uploadInput.click()}),uploadInput.addEventListener("change",()=>{const files=uploadInput.files;for(let i=0;i<files.length;i++){const file=files[i],name=file.name.replace(/\.\w+/,""),src=URL.createObjectURL(file),template=`\n        <figure>\n            <figcaption>${name}</figcaption>\n            <audio src=${src}></audio>\n        </figure>\n        `;trackList.insertAdjacentHTML("beforeend",template)}trackList.style.display="block",uploadButton.style.display="none",reloadButton.style.display="block",initPlayer()}),reloadButton.addEventListener("click",()=>{location.reload()}),navigator.serviceWorker.register("./sw.js").catch(err=>{console.error(err)});